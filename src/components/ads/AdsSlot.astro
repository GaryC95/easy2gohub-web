---
type Variant = "box" | "banner";

const {
  label = "Sponsored",
  // 兼容你现在传 string class（例如 "h-40"）
  height = "h-40",
  className = "",
  variant = "box",

  // AdSense
  adSlot, // string | number
  adFormat = "auto", // "auto" recommended
  responsive = true,
} = Astro.props as {
  label?: string;
  height?: string;
  className?: string;
  variant?: Variant;

  adSlot?: string | number;
  adFormat?: string;
  responsive?: boolean;
};

// 你的 AdSense client（固定）
const AD_CLIENT = "ca-pub-1409463603356964";

// 只在生产环境渲染真实广告
const enabled = import.meta.env.PROD;

// 生成唯一 key，确保每个 slot push 一次
const uid = `ads_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;

// 计算容器样式（你现在的 AdsSlot 是“占位卡片”，这里保留同样质感）
const containerClass =
  `tool-card bg-white/60 border border-white/60 rounded-2xl overflow-hidden ${height} ${className}`.trim();

// 如果没有 adSlot（你还没创建广告单元），即使 PROD 也继续显示占位
const canRenderReal = enabled && !!adSlot;
---

<div class={containerClass} data-ads-uid={uid}>
  <div class="px-4 pt-4 flex items-center justify-between text-[11px] font-extrabold tracking-wider uppercase text-slate-400">
    <div class="flex items-center gap-2">
      <span class="material-symbols-outlined text-slate-400 text-base">ads_click</span>
      <span>{label}</span>
    </div>
    <span class="text-slate-300">{variant.toUpperCase()}</span>
  </div>

  <div class="px-4 pb-4 pt-3 h-full">
    {canRenderReal ? (
      <div class="w-full h-full flex items-center justify-center">
        <ins
          class="adsbygoogle"
          style="display:block; width:100%; height:100%;"
          data-ad-client={AD_CLIENT}
          data-ad-slot={String(adSlot)}
          data-ad-format={adFormat}
          data-full-width-responsive={responsive ? "true" : "false"}
        ></ins>

        <script is:inline>
          {`
            (function(){
              try {
                const root = document.currentScript?.closest('[data-ads-uid]');
                if (!root) return;

                // 防止重复 push
                if (root.dataset.adsInit === "1") return;
                root.dataset.adsInit = "1";

                window.adsbygoogle = window.adsbygoogle || [];
                window.adsbygoogle.push({});
              } catch (e) {}
            })();
          `}
        </script>
      </div>
    ) : (
      // 占位（开发环境 or 还没配置 adSlot）
      <div class="w-full h-full rounded-2xl border border-dashed border-slate-200 bg-white/40 flex flex-col items-center justify-center">
        <div class="text-slate-300 font-extrabold text-xs tracking-wider uppercase">Reserved Space</div>
        <div class="text-[10px] text-slate-300 mt-1">
          {enabled && !adSlot ? "Set data-ad-slot after approval" : "Placeholder"}
        </div>
      </div>
    )}
  </div>
</div>
