---
import AdsSlot from "../ads/AdsSlot.astro";

type FaqItem = { q: string; a: string };

type ToolSeo = {
  intro?: string;
  tips?: string[];
  // 支持两种字段名：steps / howTo
  steps?: string[];
  howTo?: string[];
  faq?: FaqItem[];
};

type ToolLike = {
  title?: string;
  description?: string;
  adsProfile?: "light" | "default" | "heavy" | "none";
  seo?: ToolSeo;
};

const {
  tool,
  // 旧传参方式
  seo: seoProp,
  showAds: showAdsProp,

  // 兼容散 props
  title,
  description,
  adsProfile: adsProfileProp,
  intro: introProp,
  tips: tipsProp,
  steps: stepsProp,
  howTo: howToProp,
  faq: faqProp,
} = Astro.props as {
  tool?: ToolLike;

  seo?: ToolSeo;
  showAds?: boolean;

  title?: string;
  description?: string;
  adsProfile?: "light" | "default" | "heavy" | "none";
  intro?: string;
  tips?: string[];
  steps?: string[];
  howTo?: string[];
  faq?: FaqItem[];
};

const resolvedTitle = title ?? tool?.title ?? "Tool";
const resolvedDesc = description ?? tool?.description ?? "";

// SEO 数据来源优先级：显式 seo prop > tool.seo > 空对象
const seo = (seoProp ?? tool?.seo ?? {}) as ToolSeo;

const adsProfile = adsProfileProp ?? tool?.adsProfile ?? "default";
const showAds = (typeof showAdsProp === "boolean") ? showAdsProp : (adsProfile !== "none");

const intro =
  introProp ??
  seo.intro ??
  resolvedDesc ??
  "";

// tips
const tips: string[] =
  Array.isArray(tipsProp) ? tipsProp :
  Array.isArray(seo.tips) ? seo.tips! :
  [];

// steps/howTo 兼容：优先 stepsProp，再 howToProp，再 seo.steps，再 seo.howTo
const steps: string[] =
  Array.isArray(stepsProp) ? stepsProp :
  Array.isArray(howToProp) ? howToProp :
  Array.isArray(seo.steps) ? seo.steps! :
  Array.isArray(seo.howTo) ? seo.howTo! :
  [];

// faq
const faq: FaqItem[] =
  Array.isArray(faqProp) ? faqProp :
  Array.isArray(seo.faq) ? seo.faq! :
  [];

const showLightExtras = adsProfile === "light";
const showDefaultExtras = adsProfile === "default";
const showHeavyExtras = adsProfile === "heavy";

// SEO 区块内额外广告位规则
const showTopBanner = showAds && (showDefaultExtras || showHeavyExtras);
const showMidBox = showAds && showHeavyExtras;
const showAfterFaqBanner = showAds && (showDefaultExtras || showHeavyExtras);
---

<section class="mt-10 space-y-6">
  <div class="tool-card p-8 space-y-5">
    <div class="flex items-start justify-between gap-6">
      <div class="min-w-0">
        <h3 class="text-2xl font-extrabold text-slate-900">About {resolvedTitle}</h3>
        <p class="text-slate-500 mt-2 leading-relaxed">
          {intro || "This tool runs locally in your browser. No uploads. 100% private."}
        </p>
      </div>

      <div class="hidden md:flex shrink-0">
        <div class="px-4 py-2 rounded-full bg-indigo-500/10 text-indigo-700 font-extrabold text-xs">
          SEO & Tips
        </div>
      </div>
    </div>

    {showTopBanner ? (
      <div class="pt-4">
        <AdsSlot label="SEO – Top Banner" variant="banner" height={120} className="w-full" />
      </div>
    ) : null}

    {(steps.length > 0) ? (
      <div class="pt-2">
        <h4 class="text-sm font-extrabold text-slate-900 uppercase tracking-wider">How it works</h4>
        <ol class="mt-3 space-y-2 text-slate-600">
          {steps.map((s, i) => (
            <li class="flex gap-3">
              <span class="mt-0.5 size-6 rounded-full bg-indigo-500/10 text-indigo-700 flex items-center justify-center text-xs font-extrabold shrink-0">
                {i + 1}
              </span>
              <span class="leading-relaxed">{s}</span>
            </li>
          ))}
        </ol>
      </div>
    ) : null}

    {(tips.length > 0) ? (
      <div class="pt-2">
        <h4 class="text-sm font-extrabold text-slate-900 uppercase tracking-wider">Tips</h4>
        <ul class="mt-3 space-y-2 text-slate-600">
          {tips.map((t) => (
            <li class="flex gap-3">
              <span class="mt-1 size-2 rounded-full bg-fuchsia-500/60 shrink-0"></span>
              <span class="leading-relaxed">{t}</span>
            </li>
          ))}
        </ul>
      </div>
    ) : null}

    {showMidBox ? (
      <div class="pt-4">
        <AdsSlot label="SEO – Mid Box" variant="box" height={250} className="w-full" />
      </div>
    ) : null}

    {(faq.length > 0) ? (
      <div class="pt-2">
        <h4 class="text-sm font-extrabold text-slate-900 uppercase tracking-wider">FAQ</h4>

        <div class="mt-3 space-y-3">
          {faq.map((item) => (
            <details class="bg-white/60 border border-white/60 rounded-2xl p-4">
              <summary class="cursor-pointer font-extrabold text-slate-800">
                {item.q}
              </summary>
              <p class="mt-2 text-slate-600 leading-relaxed">
                {item.a}
              </p>
            </details>
          ))}
        </div>

        {showAfterFaqBanner ? (
          <div class="pt-5">
            <AdsSlot label="SEO – After FAQ Banner" variant="banner" height={120} className="w-full" />
          </div>
        ) : null}
      </div>
    ) : null}

    {showAds && showLightExtras ? (
      <div class="pt-4 text-xs text-slate-400 font-semibold">
        Tip: Light ad profile keeps SEO area cleaner to improve reading experience.
      </div>
    ) : null}
  </div>
</section>
