---
/**
 * Image Converter – Pro
 * Batch convert images locally (no upload) · Quality · Target format · JPEG background for alpha · Naming suffix
 * Single download / ZIP · Per-item status · Error handling · URL revoke
 *
 * Reads Settings DOM: quality, targetFormat, jpegBg, jpegBgColor, nameSuffix
 * Notes:
 * - If targetFormat is "auto", converter keeps original format (when possible).
 * - keepMetadata is currently not implemented (browser canvas export typically drops EXIF).
 */
---

<section class="tool-card p-10 space-y-10">
  <div class="text-center">
    <h2 class="text-3xl font-extrabold text-slate-900">Pro Image Converter</h2>
    <p class="text-slate-500 mt-2 text-lg">Convert images locally in your browser. No upload. 100% private.</p>
  </div>

  <div
    id="dropzone"
    class="border-2 border-dashed border-indigo-500/30 rounded-2xl bg-white/40
           hover:bg-indigo-50/40 hover:border-indigo-500 transition-all
           cursor-pointer h-72 flex flex-col items-center justify-center text-center glow-effect"
  >
    <div class="size-20 bg-indigo-500/10 rounded-full flex items-center justify-center text-indigo-600 mb-6">
      <span class="material-symbols-outlined text-4xl">swap_horiz</span>
    </div>

    <h3 class="text-xl font-extrabold text-slate-800 mb-2">Drop files here</h3>
    <p class="text-sm text-slate-400 mb-6">PNG, JPG, WEBP, AVIF up to 25MB each</p>

    <button
      id="selectBtn"
      class="bg-indigo-600 text-white px-10 py-3 rounded-full font-extrabold text-sm
             shadow-lg shadow-indigo-600/25 hover:bg-indigo-700 transition-all"
    >
      Select from computer
    </button>

    <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
  </div>

  <div id="queue" class="hidden space-y-3"></div>

  <div class="flex justify-between items-center pt-6 border-t border-slate-200/60">
    <div class="text-xs text-slate-400 font-extrabold uppercase tracking-wider">
      Status: <span id="status" class="text-emerald-600">Idle</span>
      <span id="statHint" class="ml-2 text-slate-400 font-semibold normal-case"></span>
    </div>

    <div class="flex items-center gap-3">
      <button
        id="clearBtn"
        class="px-4 py-2 rounded-xl text-sm font-extrabold bg-white/60 border border-white/50 hover:bg-white transition disabled:opacity-50"
        disabled
      >
        Clear
      </button>

      <button
        id="zipBtn"
        class="px-4 py-2 rounded-xl text-sm font-extrabold bg-white/60 border border-white/50 hover:bg-white transition disabled:opacity-50"
        disabled
        title="Download all converted images as a ZIP"
      >
        Download ZIP
      </button>

      <button
        id="processBtn"
        class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-extrabold text-sm
               shadow-lg shadow-indigo-600/25 hover:bg-indigo-700 transition-all disabled:opacity-50"
        disabled
      >
        Convert Images
      </button>
    </div>
  </div>

  <canvas id="canvas" class="hidden"></canvas>
</section>

<script type="module">
  const fileInput = document.getElementById("fileInput");
  const dropzone = document.getElementById("dropzone");
  const selectBtn = document.getElementById("selectBtn");
  const queueEl = document.getElementById("queue");
  const processBtn = document.getElementById("processBtn");
  const clearBtn = document.getElementById("clearBtn");
  const zipBtn = document.getElementById("zipBtn");
  const statusEl = document.getElementById("status");
  const statHint = document.getElementById("statHint");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  // Settings (from right panel)
  const qualityEl = document.getElementById("quality");
  const formatEl = document.getElementById("targetFormat");
  const jpegBgEl = document.getElementById("jpegBg");
  const jpegBgColorEl = document.getElementById("jpegBgColor");
  const nameSuffixEl = document.getElementById("nameSuffix");

  const MAX_SIZE = 25 * 1024 * 1024;

  const fmtBytes = (n) => {
    const u = ["B", "KB", "MB", "GB"];
    let i = 0, v = n;
    while (v >= 1024 && i < u.length - 1) { v /= 1024; i++; }
    return `${v.toFixed(i ? 2 : 0)} ${u[i]}`;
  };

  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  let items = []; // { id, file, status, error, srcUrl, inBytes, outBytes, outBlob, outName }

  function revokeAllPreviews() {
    for (const it of items) {
      if (it.srcUrl) URL.revokeObjectURL(it.srcUrl);
      it.srcUrl = null;
    }
  }

  function setStatus(text, hint = "") {
    statusEl.textContent = text;
    statHint.textContent = hint ? `• ${hint}` : "";
  }

  function totalsHint() {
    const totalBytes = items.reduce((a, it) => a + (it.inBytes || 0), 0);
    return `${items.length} file(s), ${fmtBytes(totalBytes)}`;
  }

  function anyDone() {
    return items.some((it) => it.status === "Done" && it.outBlob);
  }

  function addFiles(list) {
    for (const f of list) {
      if (!f?.type?.startsWith("image/")) continue;
      if (f.size > MAX_SIZE) continue;

      items.push({
        id: uid(),
        file: f,
        status: "Queued",
        error: "",
        srcUrl: URL.createObjectURL(f),
        inBytes: f.size,
        outBytes: 0,
        outBlob: null,
        outName: "",
      });
    }
    renderQueue();
  }

  function safeExtFromType(mime) {
    const ext = (mime || "").split("/")[1] || "jpg";
    return ext.replace("jpeg", "jpg");
  }

  function getSuffix(defaultSuffix) {
    const s = nameSuffixEl?.value?.trim();
    return s ? s : defaultSuffix;
  }

  function backgroundForJpeg() {
    const enabled = jpegBgEl?.checked;
    const mode = jpegBgColorEl?.value || "white";
    if (!enabled) return null;
    if (mode === "white") return "#ffffff";
    if (mode === "black") return "#000000";
    return "#f8fafc";
  }

  function resolveFormatForConverter(original, selected) {
    // selected: auto | image/avif | image/webp | image/jpeg | image/png
    if (!selected || selected === "auto") {
      // auto in converter = keep original format (best expectation for users)
      // If original is missing, default to jpeg
      if (original === "image/png") return "image/png";
      if (original === "image/webp") return "image/webp";
      if (original === "image/avif") return "image/avif";
      if (original === "image/jpeg") return "image/jpeg";
      return "image/jpeg";
    }
    return selected;
  }

  function downloadBlob(blob, name) {
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = name;
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
  }

  function downloadOne(id) {
    const it = items.find((x) => x.id === id);
    if (!it?.outBlob) return;
    downloadBlob(it.outBlob, it.outName || "image-output");
  }

  async function downloadZip() {
    const done = items.filter((it) => it.status === "Done" && it.outBlob);
    if (!done.length) return;

    setStatus("Zipping…", `${done.length} file(s)`);
    zipBtn.disabled = true;

    const { default: JSZip } = await import("https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm");
    const zip = new JSZip();
    for (const it of done) zip.file(it.outName, it.outBlob);

    const out = await zip.generateAsync({ type: "blob" });
    downloadBlob(out, "images-output.zip");

    zipBtn.disabled = false;
    setStatus("Done", `${done.length} converted`);
  }

  function renderQueue() {
    if (!items.length) {
      queueEl.classList.add("hidden");
      processBtn.disabled = true;
      clearBtn.disabled = true;
      zipBtn.disabled = true;
      setStatus("Idle", "");
      return;
    }

    queueEl.classList.remove("hidden");
    processBtn.disabled = false;
    clearBtn.disabled = false;
    zipBtn.disabled = !anyDone();
    setStatus("Ready", totalsHint());

    queueEl.innerHTML = "";
    for (const it of items) {
      const row = document.createElement("div");
      row.className = "flex items-center justify-between bg-white/70 rounded-2xl border border-white/60 p-4 text-sm gap-4";

      const badgeClass =
        it.status === "Done" ? "bg-emerald-500/10 text-emerald-700" :
        it.status === "Processing" ? "bg-indigo-500/10 text-indigo-700" :
        it.status === "Error" ? "bg-red-500/10 text-red-700" :
        "bg-slate-500/10 text-slate-700";

      const left = document.createElement("div");
      left.className = "min-w-0 flex items-center gap-4";

      const thumb = document.createElement("img");
      thumb.src = it.srcUrl || "";
      thumb.alt = "";
      thumb.className = "w-12 h-12 rounded-xl object-cover border border-white/60 bg-white/60 shrink-0";

      const meta = document.createElement("div");
      meta.className = "min-w-0";

      const title = document.createElement("div");
      title.className = "font-extrabold text-slate-800 truncate";
      title.textContent = it.file.name;

      const sub = document.createElement("div");
      sub.className = "text-xs text-slate-400 flex flex-wrap gap-x-3 gap-y-1";

      const sizePart = it.outBytes
        ? `${fmtBytes(it.inBytes)} → ${fmtBytes(it.outBytes)}`
        : `${fmtBytes(it.inBytes)} • ${it.file.type || "unknown"}`;

      sub.innerHTML = `<span>${sizePart}</span>`;

      meta.appendChild(title);
      meta.appendChild(sub);

      left.appendChild(thumb);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "flex items-center gap-2 shrink-0";

      const badge = document.createElement("div");
      badge.className = `px-3 py-1 rounded-full text-xs font-extrabold ${badgeClass}`;
      badge.textContent = it.status;

      const downloadBtn = document.createElement("button");
      downloadBtn.className = "px-3 py-2 rounded-xl text-xs font-extrabold bg-white/60 border border-white/50 hover:bg-white transition disabled:opacity-50";
      downloadBtn.textContent = "Download";
      downloadBtn.disabled = !(it.status === "Done" && it.outBlob);
      downloadBtn.onclick = () => downloadOne(it.id);

      const removeBtn = document.createElement("button");
      removeBtn.className = "text-slate-400 hover:text-red-500 font-extrabold px-2";
      removeBtn.textContent = "✕";
      removeBtn.onclick = () => removeOne(it.id);

      right.appendChild(badge);
      right.appendChild(downloadBtn);
      right.appendChild(removeBtn);

      row.appendChild(left);
      row.appendChild(right);

      if (it.status === "Error" && it.error) {
        const err = document.createElement("div");
        err.className = "mt-3 text-xs font-semibold text-red-600 bg-red-500/10 border border-red-500/10 rounded-xl p-3";
        err.textContent = it.error;

        const wrap = document.createElement("div");
        wrap.className = "w-full";
        wrap.appendChild(row);
        wrap.appendChild(err);
        queueEl.appendChild(wrap);
      } else {
        queueEl.appendChild(row);
      }
    }
  }

  function removeOne(id) {
    const idx = items.findIndex((x) => x.id === id);
    if (idx === -1) return;
    const it = items[idx];
    if (it?.srcUrl) URL.revokeObjectURL(it.srcUrl);
    items.splice(idx, 1);
    renderQueue();
  }

  async function convertOne(file, quality, outType) {
    const bmp = await createImageBitmap(file);
    const w = bmp.width, h = bmp.height;

    canvas.width = w;
    canvas.height = h;

    if (outType === "image/jpeg") {
      const bg = backgroundForJpeg();
      if (bg) {
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, w, h);
      } else {
        ctx.clearRect(0, 0, w, h);
      }
    } else {
      ctx.clearRect(0, 0, w, h);
    }

    ctx.drawImage(bmp, 0, 0, w, h);

    const blob = await new Promise((res) => canvas.toBlob(res, outType, quality));
    return blob;
  }

  async function processAll() {
    if (!items.length) return;

    const quality = qualityEl ? Number(qualityEl.value || 80) / 100 : 0.8;
    const selectedFormat = formatEl ? formatEl.value : "auto";
    const suffix = getSuffix("-converted");

    processBtn.disabled = true;
    zipBtn.disabled = true;

    for (const it of items) {
      it.status = "Queued";
      it.error = "";
      it.outBlob = null;
      it.outBytes = 0;
      it.outName = "";
    }
    renderQueue();

    const total = items.length;
    let doneCount = 0;

    for (let i = 0; i < items.length; i++) {
      const it = items[i];
      try {
        it.status = "Processing";
        renderQueue();
        setStatus("Processing…", `${i + 1}/${total}`);

        const targetType = resolveFormatForConverter(it.file.type, selectedFormat);
        const blob = await convertOne(it.file, quality, targetType);
        if (!blob) throw new Error("Failed to export image (toBlob returned null).");

        const ext = safeExtFromType(targetType);
        const base = it.file.name.replace(/\.[^.]+$/, "");
        it.outName = `${base}${suffix}.${ext}`;
        it.outBlob = blob;
        it.outBytes = blob.size || 0;

        it.status = "Done";
        doneCount++;
        renderQueue();
      } catch (e) {
        it.status = "Error";
        it.error = e?.message ? String(e.message) : "Unknown error";
        renderQueue();
      }
    }

    processBtn.disabled = false;
    zipBtn.disabled = !anyDone();
    setStatus("Done", `${doneCount}/${total} converted`);
  }

  selectBtn.onclick = () => fileInput.click();
  fileInput.onchange = () => addFiles(fileInput.files);

  dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add("ring-2", "ring-indigo-500"); };
  dropzone.ondragleave = () => dropzone.classList.remove("ring-2", "ring-indigo-500");
  dropzone.ondrop = (e) => {
    e.preventDefault();
    dropzone.classList.remove("ring-2", "ring-indigo-500");
    addFiles(e.dataTransfer.files);
  };

  clearBtn.onclick = () => {
    revokeAllPreviews();
    items = [];
    renderQueue();
    setStatus("Idle", "");
  };

  processBtn.onclick = processAll;
  zipBtn.onclick = downloadZip;

  window.addEventListener("beforeunload", () => revokeAllPreviews());
</script>
