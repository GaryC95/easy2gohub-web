---
const id = "image-resizer";
---

<section class="mx-auto max-w-3xl">
  <div class="rounded-2xl border bg-white p-6 shadow-sm">
    <h1 class="text-2xl font-semibold tracking-tight">Image Resizer</h1>
    <p class="mt-2 text-sm text-gray-600">
      Resize JPG/PNG/WebP locally in your browser. No upload.
    </p>

    <div class="mt-6 grid gap-4">
      <div>
        <label class="text-sm font-medium text-gray-700">Select an image</label>
        <input
          id={`${id}-file`}
          type="file"
          accept="image/*"
          class="mt-2 block w-full cursor-pointer rounded-xl border p-3 text-sm"
        />
        <p id={`${id}-hint`} class="mt-2 text-xs text-gray-500">
          Tip: Large images may take a few seconds on older devices.
        </p>
      </div>

      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div>
          <label class="text-sm font-medium text-gray-700">Width (px)</label>
          <input
            id={`${id}-w`}
            type="number"
            min="1"
            inputmode="numeric"
            class="mt-2 w-full rounded-xl border p-3 text-sm"
            placeholder="e.g. 1200"
          />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Height (px)</label>
          <input
            id={`${id}-h`}
            type="number"
            min="1"
            inputmode="numeric"
            class="mt-2 w-full rounded-xl border p-3 text-sm"
            placeholder="e.g. 800"
          />
        </div>
      </div>

      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <label class="inline-flex items-center gap-2 text-sm text-gray-700">
          <input id={`${id}-lock`} type="checkbox" class="h-4 w-4" checked />
          Keep aspect ratio
        </label>

        <div class="flex flex-col gap-3 md:flex-row md:items-center">
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700">Format</label>
            <select id={`${id}-fmt`} class="rounded-xl border p-2 text-sm">
              <option value="image/jpeg">JPG</option>
              <option value="image/png">PNG</option>
              <option value="image/webp">WebP</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700">Quality</label>
            <input id={`${id}-q`} type="range" min="50" max="100" value="85" />
            <span id={`${id}-qv`} class="w-10 text-right text-sm text-gray-700">85</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
        <button
          id={`${id}-btn`}
          class="rounded-2xl bg-black px-4 py-3 text-sm font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
          disabled
        >
          Resize & Download
        </button>
        <button
          id={`${id}-reset`}
          class="rounded-2xl border px-4 py-3 text-sm font-semibold text-gray-900"
          type="button"
        >
          Reset
        </button>
      </div>

      <div class="rounded-2xl border bg-gray-50 p-4">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <p class="text-sm font-medium text-gray-900">Preview</p>
          <p id={`${id}-meta`} class="text-xs text-gray-600">No file loaded</p>
        </div>
        <div class="mt-3 overflow-hidden rounded-xl border bg-white">
          <img id={`${id}-preview`} alt="Preview" class="hidden w-full object-contain" />
          <div id={`${id}-empty`} class="p-10 text-center text-sm text-gray-500">
            Choose an image to preview.
          </div>
        </div>
      </div>

      <p id={`${id}-err`} class="hidden rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"></p>
    </div>
  </div>
</section>

<script>
  const $ = (sel) => document.querySelector(sel);

  const fileEl = $("#image-resizer-file");
  const wEl = $("#image-resizer-w");
  const hEl = $("#image-resizer-h");
  const lockEl = $("#image-resizer-lock");
  const fmtEl = $("#image-resizer-fmt");
  const qEl = $("#image-resizer-q");
  const qvEl = $("#image-resizer-qv");
  const btnEl = $("#image-resizer-btn");
  const resetEl = $("#image-resizer-reset");

  const previewEl = $("#image-resizer-preview");
  const emptyEl = $("#image-resizer-empty");
  const metaEl = $("#image-resizer-meta");
  const errEl = $("#image-resizer-err");

  let original = { w: 0, h: 0, name: "", mime: "" };
  let objectUrl = "";

  const showErr = (msg) => {
    errEl.textContent = msg;
    errEl.classList.remove("hidden");
  };
  const clearErr = () => {
    errEl.textContent = "";
    errEl.classList.add("hidden");
  };

  const setMeta = (text) => (metaEl.textContent = text);

  const resetAll = () => {
    clearErr();
    btnEl.disabled = true;
    fileEl.value = "";
    wEl.value = "";
    hEl.value = "";
    lockEl.checked = true;
    fmtEl.value = "image/jpeg";
    qEl.value = "85";
    qvEl.textContent = "85";
    original = { w: 0, h: 0, name: "", mime: "" };
    setMeta("No file loaded");
    previewEl.classList.add("hidden");
    emptyEl.classList.remove("hidden");
    previewEl.removeAttribute("src");
    if (objectUrl) URL.revokeObjectURL(objectUrl);
    objectUrl = "";
  };

  qEl.addEventListener("input", () => (qvEl.textContent = String(qEl.value)));

  const updateLocked = (changed) => {
    if (!lockEl.checked) return;
    if (!original.w || !original.h) return;

    const w = parseInt(wEl.value || "0", 10);
    const h = parseInt(hEl.value || "0", 10);

    if (changed === "w" && w > 0) {
      const nh = Math.round((w * original.h) / original.w);
      hEl.value = String(nh);
    } else if (changed === "h" && h > 0) {
      const nw = Math.round((h * original.w) / original.h);
      wEl.value = String(nw);
    }
  };

  wEl.addEventListener("input", () => updateLocked("w"));
  hEl.addEventListener("input", () => updateLocked("h"));

  fileEl.addEventListener("change", async () => {
    clearErr();

    const f = fileEl.files?.[0];
    if (!f) return;

    if (!f.type.startsWith("image/")) {
      showErr("Please select a valid image file.");
      resetAll();
      return;
    }

    if (objectUrl) URL.revokeObjectURL(objectUrl);
    objectUrl = URL.createObjectURL(f);

    const img = new Image();
    img.onload = () => {
      original = { w: img.naturalWidth, h: img.naturalHeight, name: f.name, mime: f.type };
      wEl.value = String(original.w);
      hEl.value = String(original.h);
      btnEl.disabled = false;

      previewEl.src = objectUrl;
      previewEl.classList.remove("hidden");
      emptyEl.classList.add("hidden");

      setMeta(`${original.w}×${original.h} • ${(f.size / 1024).toFixed(1)} KB • ${f.type}`);
    };
    img.onerror = () => {
      showErr("Failed to load the image. Try another file.");
      btnEl.disabled = true;
    };
    img.src = objectUrl;
  });

  const extFromMime = (mime) => {
    if (mime === "image/png") return "png";
    if (mime === "image/webp") return "webp";
    return "jpg";
  };

  const downloadBlob = (blob, filename) => {
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  btnEl.addEventListener("click", async () => {
    clearErr();

    const f = fileEl.files?.[0];
    if (!f) return showErr("Please select an image first.");

    const targetW = parseInt(wEl.value || "0", 10);
    const targetH = parseInt(hEl.value || "0", 10);
    if (!targetW || !targetH || targetW <= 0 || targetH <= 0) {
      return showErr("Please enter valid width and height.");
    }

    btnEl.disabled = true;
    btnEl.textContent = "Processing...";

    try {
      const bmp = await createImageBitmap(f);
      const canvas = document.createElement("canvas");
      canvas.width = targetW;
      canvas.height = targetH;

      const ctx = canvas.getContext("2d", { alpha: true });
      if (!ctx) throw new Error("Canvas not supported.");

      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";
      ctx.drawImage(bmp, 0, 0, targetW, targetH);

      const mime = fmtEl.value;
      const q = Math.max(0.5, Math.min(1, Number(qEl.value) / 100));

      const blob = await new Promise((resolve, reject) => {
        // PNG ignores quality; JPG/WebP use it.
        canvas.toBlob(
          (b) => (b ? resolve(b) : reject(new Error("Failed to export image."))),
          mime,
          q
        );
      });

      const base = (original.name || "resized").replace(/\.[^.]+$/, "");
      const ext = extFromMime(mime);
      const filename = `${base}-${targetW}x${targetH}.${ext}`;
      downloadBlob(blob, filename);
    } catch (e) {
      showErr(e?.message || "Failed to resize the image.");
    } finally {
      btnEl.disabled = false;
      btnEl.textContent = "Resize & Download";
    }
  });

  resetEl.addEventListener("click", resetAll);
</script>
