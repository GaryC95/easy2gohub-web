---
import { CATEGORY_META, CATEGORY_ORDER, getToolsByCategory } from "../../data/tools";

const path = Astro.url.pathname;

// 以 /image/image-compressor/ 这种路径判断 active
function isActive(category: string, slug: string) {
  return path.startsWith(`/${category}/${slug}/`);
}
function isCategoryActive(category: string) {
  return path === `/${category}/` || path.startsWith(`/${category}/`);
}
---

<aside class="w-64 glass-sidebar flex flex-col overflow-y-auto no-scrollbar">
  <!-- Brand -->
  <div class="p-6 border-b border-slate-200/30">
    <a href="/" class="flex items-center gap-3">
      <div class="w-9 h-9 bg-gradient-to-br from-indigo-500 to-fuchsia-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/20">
        <span class="material-symbols-outlined !text-xl">hub</span>
      </div>
      <div class="leading-tight">
        <div class="font-extrabold text-slate-900 tracking-tight">
          Easy2Go<span class="text-indigo-600">Hub</span>
        </div>
        <div class="text-[11px] text-slate-400 font-semibold">Productivity Tools</div>
      </div>
    </a>

    <!-- Sidebar Search -->
    <div class="mt-5 relative">
      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[18px]">search</span>
      <input
        id="sidebarSearch"
        type="text"
        placeholder="Search tools…"
        class="w-full bg-white/60 border border-white/50 focus:ring-2 focus:ring-indigo-500/20 focus:bg-white transition-all rounded-xl pl-10 pr-3 py-2 text-sm"
        autocomplete="off"
      />
    </div>

    <!-- Quick links -->
    <div class="mt-4 flex gap-2">
      <a href="/tools/" class="flex-1 text-center text-xs font-bold px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 transition">
        All Tools
      </a>
      <a href="/" class="flex-1 text-center text-xs font-bold px-3 py-2 rounded-xl bg-white/60 border border-white/50 hover:bg-white transition">
        Home
      </a>
    </div>
  </div>

  <!-- Nav -->
  <nav class="p-4 space-y-3">
    <div class="text-[10px] uppercase font-bold tracking-[0.18em] text-slate-400 px-2">
      Explorer
    </div>

    {CATEGORY_ORDER.map((cat) => {
      const meta = CATEGORY_META[cat];
      const list = getToolsByCategory(cat);
      const open = isCategoryActive(cat);

      return (
        <details class="group" open={open}>
          <summary class="flex items-center justify-between gap-2 p-2.5 rounded-xl cursor-pointer hover:bg-white/50 transition list-none">
            <div class="flex items-center gap-2.5 min-w-0">
              <span class="material-symbols-outlined text-slate-400 group-open:rotate-90 transition-transform">chevron_right</span>
              <span class={`material-symbols-outlined text-[18px] ${meta.badgeColor}`}>{meta.icon}</span>
              <div class="min-w-0">
                <div class="text-sm font-extrabold text-slate-800 truncate">
                  {meta.label}
                </div>
                <div class="text-[11px] text-slate-400 truncate">{meta.desc}</div>
              </div>
            </div>

            <span class="text-[10px] font-extrabold text-slate-400 bg-white/70 border border-white/60 px-2 py-0.5 rounded-full">
              {list.length}
            </span>
          </summary>

          <div class="mt-2 ml-4 border-l-2 border-slate-100 space-y-1" data-cat-panel>
            {list.map((t) => {
              const active = isActive(t.category, t.slug);
              return (
                <a
                  href={`/${t.category}/${t.slug}/`}
                  class={active ? "tree-link tree-link-active" : "tree-link"}
                  data-tool-item
                  data-search={`${t.title} ${t.slug} ${t.tags?.join(" ") || ""} ${meta.label}`.toLowerCase()}
                >
                  <div class="flex items-center gap-2">
                    <span class={`material-symbols-outlined text-[18px] ${active ? "text-indigo-600" : "text-slate-400"}`}>
                      {t.icon}
                    </span>
                    <span class="truncate">{t.title}</span>
                  </div>
                </a>
              );
            })}
          </div>
        </details>
      );
    })}
  </nav>

  <!-- Footer / Upgrade -->
  <div class="p-4 mt-auto">
    <div class="rounded-2xl p-4 bg-indigo-50/60 border border-indigo-100/80">
      <div class="text-[10px] uppercase tracking-widest font-extrabold text-indigo-600 mb-1">Pro Workspace</div>
      <div class="text-xs text-slate-600 leading-relaxed">
        Batch + larger limits + advanced settings (coming soon).
      </div>
      <a href="/tools/" class="inline-flex items-center gap-1 mt-3 text-xs font-extrabold text-indigo-600 hover:underline">
        Explore more <span class="material-symbols-outlined text-[16px]">arrow_forward</span>
      </a>
    </div>
  </div>

  <script type="module">
    const input = document.getElementById("sidebarSearch");
    const items = Array.from(document.querySelectorAll("[data-tool-item]"));

    function norm(s){ return (s || "").toLowerCase().trim(); }

    input?.addEventListener("input", () => {
      const q = norm(input.value);
      for (const el of items) {
        const hay = norm(el.getAttribute("data-search"));
        el.classList.toggle("hidden", q && !hay.includes(q));
      }
    });
  </script>
</aside>
